## readdata inputs data sets + preprocesses, saves objects as RData
## appends data from csv to datafilename (.RData), if filename is given

readairdata<-function(csvfilename,datafilename=NULL){
# data filename
# filename should match this scripts filename, to be able to use makefile (update only if)
if (!is.null(datafilename)){
  if(file.exists(datafilename)){
    # read that file
    print(paste("loading",datafilename))
    load(datafilename)
  }else{ # fail to find file
	  warn(paste("readairdata - file not found:",datafilename))
	  return
	  }
}

    # get data from
    # https://paste.madflex.de/d9rcQxUT#particlesdata.csv
    # and clean errors:
    # sed -i -e '/\r.\+/d;/ovf/d;' data/particlesdata.csv

    # try particlesdata, then sampledata
    data.csv.filename=csvfilename
    if (file.exists(data.csv.filename)){
        airdat <- read.csv(data.csv.filename,dec=".", sep=",", na.strings=c("","NA"))
    }else{
        warning(paste("datafile ",data.csv.filename," not found, using sampledata"))
        data.csv.filename="data/sampledata.csv"
        airdat <- read.csv(data.csv.filename,dec=".", sep=",", na.strings=c("","NA"))
    }
    #ppd <- filter(dat, type=="PPD42NS")
    #
    ## Timestamps formatieren
    # pattern <- "[0-9]+-[0-9]+-[0-9]+ [0-9][0-9]:[0-9][0-9]:[0-9][0-9]"
    # dat <- dat %>%
    #     mutate(timestamp2 = regexpr(pattern, timestamp)) %>%
    #     mutate(timestamp2 = regmatches(timestamp, timestamp2)) %>%
    #     mutate(timestamp2=ymd_hms(timestamp2))
    airdat$timestamp2<-as.POSIXct(strptime(airdat$timestamp,format="%Y-%m-%d %H:%M:%S"))
    # dat$timestamp2<-strptime(dat$timestamp,format="%d.%m.%y %H:%M:%S+%Z")

    # str(dat)
    # 'data.frame':   319836 obs. of  27 variables:
    #  $ timestamp        : Factor w/ 319831 levels "2015-04-05 23:13:10.759068+00:00",..: 319822 319805 319788 319771 319754 319737 319720 319703 319686 319669 ...
    # sensor type
    #  $ type             : Factor w/ 3 levels "dsm501a","GP2Y1010AU0F",..: 1 1 1 1 1 1 1 1 1 1 ...
    #  $ indoor           : Factor w/ 2 levels "False","True": 2 2 2 2 2 2 2 2 2 2 ...
    #  $ location_id      : int  4 4 4 4 4 4 4 4 4 4 ...
    #  $ sampling_rate    : int  15000 15000 15000 15000 15000 15000 15000 15000 15000 15000 ...
    #
    #  $ P1               : Factor w/ 61894 levels "","017.95","05.06",..: 1 1 1 1 1 1 1 1 1 1 ...
    #  $ P2               : num  NA NA NA NA NA NA NA NA NA NA ...
    #  $ durP1            : num  NA NA NA NA NA NA NA NA NA NA ...
    #  $ durP2            : int  NA NA NA NA NA NA NA NA NA NA ...
    #  $ ratioP1          : num  NA NA NA NA NA NA NA NA NA NA ...
    #  $ ratioP2          : num  NA NA NA NA NA NA NA NA NA NA ...
    #  $ temperature      : logi  NA NA NA NA NA NA ...
    #  $ humidity         : logi  NA NA NA NA NA NA ...
    #  $ pressure         : logi  NA NA NA NA NA NA ...
    #  $ altitude         : logi  NA NA NA NA NA NA ...
    #  $ pressure_sealevel: logi  NA NA NA NA NA NA ...
    #  $ brightness       : logi  NA NA NA NA NA NA ...
    #  $ dust_density     : Factor w/ 77 levels "","-.00",".00",..: 1 1 1 1 1 1 1 1 1 1 ...
    #  $ vo_raw           : num  NA NA NA NA NA NA NA NA NA NA ...
    #  $ voltage          : num  NA NA NA NA NA NA NA NA NA NA ...
    #  $ P10              : num  16656 28523 15669 12731 14018 ...
    #  $ P25              : num  3514 4474 3570 3104 3552 ...
    #  $ durP10           : int  2906824 3794072 2812860 2503032 2644788 2711264 2342328 2416972 2560024 2548652 ...
    #  $ durP25           : int  972924 1198488 986724 870160 982288 969476 902680 850496 924380 968796 ...
    #  $ ratioP10         : num  19.4 25.3 18.8 16.7 17.6 ...
    #  $ ratioP25         : num  6.49 7.99 6.58 5.8 6.55 6.46 6.02 5.67 6.16 6.46 ...
    #  $ timestamp2       : POSIXct, format: "2015-05-05 08:15:59" "2015-05-05 08:15:44" ...

    # P1 should be numeric
    # TODO: identify problematic entries
    # DONE with preprocessing (sed)
#     dat$P1num<-as.numeric(as.character(dat$P1))
#     ## dust_density should be numeric
#     dat$dust_density_num=as.numeric(as.character(dat$dust_density))

if(!is.null(datafilename)){
    # save all stuff currently in workspace
    save(airdat,file=datafilename)
}
return(airdat)
}
